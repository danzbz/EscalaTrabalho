@model EscalaTrabalho.Model.CalendarioMOD

<table id="eventos" class="d-none">
    @foreach (var dia in Model.ListaDiasUteis)
    {
        @foreach (var funcionario in dia.ListaFuncionarioNaEscala)
        {
            <tr>
                <td>@funcionario.Id</td>
                <td>@funcionario.NmFuncionario</td>
                <td>@dia.DtInicio.ToString("yyyy-MM-dd")</td>
            </tr>
        }
    }
</table>

<table id="eventosFeriados" class="d-none">
    @foreach (var feriado in Model.ListaFeriadoPublico)
    {
        <tr>
            <td>@feriado.Global</td>
            <td>@feriado.LocalName</td>
            <td>@feriado.Date.ToString("yyyy-MM-dd")</td>
        </tr>
    }
</table>

<div class="row">

    <div class="col-12">
        <table class="table">
            <thead>
                <tr>
                    <td>ID</td>
                    <td>
                        Colaborador
                    </td>
                    <td>Qtd. de Homes</td>
                </tr>

                @foreach (var funcionario in Model.ListaFuncionario)
                {
                    <tr>
                        <td>@funcionario.Id</td>
                        <td id="colaborador-@funcionario.Id">
                            @funcionario.NmFuncionario
                        </td>
                        <td id="homes-@funcionario.Id">
                            @Model.ListaDiasUteis.Where(x => x.ListaFuncionarioNaEscala.Any(y => y.Id == funcionario.Id)).Count()
                        </td>
                    </tr>
                }

            </thead>
        </table>
    </div>

    <div class="col-12">
        <div id="calendar"></div>
    </div>
</div>

<script>
    let listaEventos = carregarDados();
    let calendar = gerarCalendario();

    function carregarDados() {
        let listaEventos = [];

        let tabelaHome = document.getElementById("eventos");
        let trElem = tabelaHome.getElementsByTagName("tr");
        for (let tr of trElem) {
            let tdElems = tr.getElementsByTagName("td");
            let eventoObjeto = {
                id: tdElems[0].innerText,
                title: tdElems[1].innerText,
                start: tdElems[2].innerText,
                color: obterCorPorFuncionario(tdElems[0].innerText) // Obtém cor para o funcionário com base no ID
            }
            listaEventos.push(eventoObjeto);
        }

        let tabelaFeriado = document.getElementById("eventosFeriados");
        let trFeriado = tabelaFeriado.getElementsByTagName("tr");
        for (let tr of trFeriado) {
            let tdElems = tr.getElementsByTagName("td");
            let eventObj = {
                id: tdElems[0].innerText,
                title: tdElems[1].innerText,
                start: tdElems[2].innerText,
                color: 'red'
            }
            listaEventos.push(eventObj);
        }

        return listaEventos;
    }

    function obterCorPorFuncionario(funcionarioId) {
        let mapeamentoCor = {
            "1": "blue",
            "2": "green",
            "3": "purple",
            "4": "black",
        };
        return mapeamentoCor[funcionarioId] || 'gray'; 
    }

    // Função para inicializar o calendário
    function gerarCalendario() {
        var calendarEl = document.getElementById('calendar');

        let calendar = new FullCalendar.Calendar(calendarEl, {
            editable: true,
            locale: 'pt-br',
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            events: listaEventos,
            eventColor: function (arg) {
                return arg.event.extendedProps.color;
            },
            dateClick: function (info) {
                let colaboradorId = prompt("Informe o ID do colaborador:");
                if (colaboradorId) {
                    let dataEvento = info.dateStr;
                    let novoEvento = {
                        id: colaboradorId + '-' + dataEvento,
                        title: $('#colaborador-' + colaboradorId).text(),
                        start: dataEvento,
                        color: obterCorPorFuncionario(colaboradorId)
                    };
                    listaEventos.push(novoEvento);
                    calendar.addEvent(novoEvento);
                    atualizarContagemHomes(colaboradorId, 1); // Adiciona 1 à contagem
                }
            },
            eventClick: function (info) {
                if (confirm("Deseja realmente remover este evento?")) {
                    let eventoId = info.event.id;
                    let colaboradorId = eventoId.split('-')[0];
                    let index = listaEventos.findIndex(evento => evento.id === eventoId);
                    if (index !== -1) {
                        listaEventos.splice(index, 1);
                        calendar.getEventById(eventoId).remove();
                        atualizarContagemHomes(colaboradorId, -1); // Subtrai 1 da contagem
                    }
                }
            }
        });

        calendar.render();

        return calendar;
    }

    // Função para atualizar a contagem de homes na tabela
    function atualizarContagemHomes(colaboradorId, alteracao) {
        let homesTd = $(`#homes-${colaboradorId}`);
        if (homesTd) {
            homesTd.textContent = parseInt(homesTd.textContent) + alteracao;
        }
    }
</script>
